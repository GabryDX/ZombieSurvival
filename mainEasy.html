<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
</head>

<body style="margin: 0px; background-color: #3f3f3f; overflow: hidden;">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/105/three.js" integrity="sha256-NncZTBhUdU+UoOVS7s+6ou1L+4zhUVvFcLxV6q3oubw=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/105/three.min.js" integrity="sha256-Mc6q7xXvKBXW87eVjSASXbPqfuc9tHqbn6AHp1R97J4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/105/three.module.js" integrity="sha256-Is6nOTHl1vGG3RgNJq+Ed3wVLOe+0cnj3+OQsBD0uCQ=" crossorigin="anonymous"></script>
    <script src="js/threex.proceduralcity2.js"></script>
    <script src="js/FirstPersonControls.js"></script>
    <script type="module" src="js/CylinderGeometry.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>



<p id="time" align="center"></p>
<p id="ris" align="center"></p>
<script>

  console.log(THREE.REVISION);
  var map = [ // 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,], // 0
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 1
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 2
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 3
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 4
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 5
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 6
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 7
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 8
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 9
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 10
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], //11
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 12
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 13
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 14
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 15
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,], // 16
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,], //17
            ], mapW = map.length, mapH = map[0].length;

  var enemy5;
  var pun = 0;
  var tempo = 10;
  var UNITSIZE = 20,
  MOVESPEED = 150,
  LOOKSPEED = 1,
  BULLETMOVESPEED = MOVESPEED * 5,
  NUMAI = 100,
  DURATIONTIME=92000; //in millisec
  var width = window.innerWidth;
  var height = window.innerHeight;
  
  var t = THREE,renderer, clock, projector, model, skin;

  var renderer  = new THREE.WebGLRenderer({antialiasing  : true});
  renderer.setSize( width, height );
  document.body.appendChild( renderer.domElement );
  
  var mouse = { x: 0, y: 0 };
  var ai = [];
  var updateFcts  = [];
  //____________________________SCENE & CAMERA_______________________________________
  var scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2( 0xd0e0f0, 0.0025 );
  
  var camera  = new THREE.PerspectiveCamera(45, width / height, 0.3, 1000 );
  camera.position.z = 45;
  camera.position.x = 45;
  scene.add(camera);

  //___________________________PROCEDURAL CITY_______________________________________
  var proceduralCity = new THREEx.ProceduralCity();
  //Basically we have 2 cities: createSquareCity() and createMrDoobCity();
  var city  = proceduralCity.createSquareCity();
  scene.add(city);

  //setupAI();

  //_____________________________________LIGHT________________________________________
  var light = new THREE.HemisphereLight( 0xfffff0, 0x101020, 1.25 );
  light.position.set( 1, 1, 0.25 );
  scene.add( light );

  //________________________________WEAPON_____________________________________________
  var models = { 
    uzi: {
      obj:"models/uziGold.obj",
      mtl:"models/uziGold.mtl",
      mesh: null,
      castShadow:false
    }
  };


  // bullets
  var bullets = [];
  var canShoot = 0;
  var keyboard = {};
  projector = new THREE.Raycaster();
  var vector = new THREE.Vector3();

  camera.position.y = 1.85;
  camera.position.z = 200;

  var controls, clock;
  clock = new THREE.Clock();
  controls = new THREE.FirstPersonControls(camera);
  document.addEventListener( 'click', function () {controls.lock();}, false );
  controls.movementSpeed = MOVESPEED;
  controls.lookSpeed = LOOKSPEED;
  controls.lookVertical = false; // Temporary solution; play on flat surfaces only
  controls.noFly = true;

  // Track mouse position so we know where to shoot
  document.addEventListener( 'mousemove', onDocumentMouseMove, false );

  // Set the date we're counting down to
  var date = new Date().getTime();
  var countDownDate = date + DURATIONTIME;

  // Update the count down every 1 second
  var x = setInterval(function(){
    tempo -=1;
    // Get the "now" date
    var now1 = new Date().getTime();

    // Find the distance between now an the count down date
    var distance = countDownDate - now1;

    var sec = Math.floor(distance/1000);
    document.getElementById("time").innerHTML = "<span style='font-family: Impact; font-size: 15px; color:#00FF00'>  Remaining time: " + sec +" sec"+"&nbsp&nbsp&nbsp Punteggio: "+pun+"</span>";


    // If the count down is finished, write some text
    if (distance < 0) {
      document.exitPointerLock();
      document.removeEventListener( 'click', function () {
                    controls.lock();
                    }, false );
      clearInterval(x);
      document.getElementById("time").innerHTML = "<br /><span style='font-family: Impact; font-size: 60px; color:#00FF00'>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp <h1>TIME OUT!</h1></span>";
      document.getElementById("ris").innerHTML = "<span style='font-family: Impact; font-size: 60px; color:#00FF00'><h1> Score:  " + pun+ "</span>"+ "<br /><span style='font-family: Impact; font-size: 60px; color:#00FF00'>"+"<a href='index.html'> Restart</a>"+"</h1></span>";
      $(renderer.domElement).fadeOut();
    }
  }, 1000);


  //////////////////////////////////////////////////////////////////////////////////
  //    render the scene            //
  //////////////////////////////////////////////////////////////////////////////////
  updateFcts.push(function(){
  
    pun =NUMAI - ai.length;

    var delta = clock.getDelta(), speed = delta * BULLETMOVESPEED;
    var aispeed = delta * MOVESPEED *0.1;
    var time = Date.now() * 0.0005;
    renderer.render( scene, camera );
    controls.update(clock.getDelta());  // only if control is FirstPersonControls
     
    castRays();


    // SHOOT BULLET
    for(var index=0; index<bullets.length; index+=1){
      if( bullets[index] === undefined ) continue;
      if( bullets[index].alive == false ){
      bullets.splice(index,1);
      continue;
      }

      bullets[index].position.add(bullets[index].velocity);
    }

    if(keyboard[32] && canShoot <= 0){ // spacebar key

    // creates a bullet as a Mesh object
    var bullet = new THREE.Mesh(
                                new THREE.SphereGeometry(0.2,8,8),
                                new THREE.MeshBasicMaterial({color:0x42FFFF})
                                );
    bullet.position.set(
                        camera.position.x - 0.7*parseInt(-Math.cos(camera.rotation.x)),
                        camera.position.y - 0.3,
                        camera.position.z
                        );
        
    // set the velocity of the bullet
    bullet.velocity = new THREE.Vector3(
                                       ((mouse.x*parseInt(Math.cos(camera.rotation.z))) - Math.sin(camera.rotation.y) * 0.75),//*parseInt(-Math.cos(camera.rotation.z)) ,
                                        0,//mouse.y,
                                        Math.cos(camera.rotation.y)*parseInt(-Math.cos(camera.rotation.z))
                                      ).normalize();
    bullet.alive = true;
    setTimeout(function(){
               bullet.alive = false;
               scene.remove(bullet);
               }, 1000);
    // add to scene, array, and set the delay to 10 frames
    bullets.push(bullet);
    scene.add(bullet);
    canShoot = 10;
    }
    if(canShoot > 0) canShoot -= 1;
  });
          
function getMapSector(v){
  var x = Math.floor((v.x + UNITSIZE / 2) / UNITSIZE + mapW/2);
  var z = Math.floor((v.z + UNITSIZE / 2) / UNITSIZE + mapW/2);
  return {x: x, z: z};
}

function getRandBetween(lo, hi){return parseInt(Math.floor(Math.random()*(hi-lo+1))+lo, 10);}



  //////////////////////////////////////////////////////////////////////////////////
  //    loop runner             //
  //////////////////////////////////////////////////////////////////////////////////
  var lastTimeMsec= null
  requestAnimationFrame(function animate(nowMsec){
    // keep looping
    requestAnimationFrame( animate );
    // measure time
    lastTimeMsec  = lastTimeMsec || nowMsec-1000/60
    var deltaMsec = Math.min(200, nowMsec - lastTimeMsec)
    lastTimeMsec  = nowMsec

                      function keyDown(event)
                      {
                          keyboard[event.keyCode] = true;
                          }

                          function keyUp(event){
                          keyboard[event.keyCode] = false;
                          }

                          window.addEventListener('keydown', keyDown);
                          window.addEventListener('keyup', keyUp);




        // call each update function
    updateFcts.forEach(function(updateFn)
    {
      updateFn(deltaMsec/1000, nowMsec/1000)
    })


  })



  function castRays(){
    var direction = new THREE.Vector3(1000, 5500, 1000);
    var startPoint = camera.position.clone();
    var directionVector = direction.sub( startPoint );
    var ray = new THREE.Raycaster(startPoint, directionVector.clone(). normalize());
    scene.updateMatrixWorld();     // required, since you haven't rendered yet
    var rayIntersects = ray.intersectObjects(scene.children, true);
    if (rayIntersects.length > 0){
      camera.position.z = camera.position.z - 5;
      camera.position.x = camera.position.x - 5;
    }
  }

  function onDocumentMouseMove(e){
    e.preventDefault();
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = - (e.clientY / window.innerHeight) * 2 + 1;
  }




</script><canvas width="1440" height="757"></canvas>
</body></html>
